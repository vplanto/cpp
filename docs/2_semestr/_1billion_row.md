# –ü—Ä–∞–∫—Ç–∏–∫—É–º ?: Performance Engineering ‚Äî "1 Billion Row Challenge" (Lite)
Source https://itnext.io/daily-bit-e-of-c-optimizing-code-to-run-87x-faster-7ef0b5bc64a1

‚Üê [Index](index.md)

**–¢–µ–æ—Ä—ñ—è:** [–õ–µ–∫—Ü—ñ—è 19: Performance Engineering](19_complexity_profiling.md)

---

## –ù–∞—à "–ø—Ä–æ–¥—É–∫—Ç" —Å—å–æ–≥–æ–¥–Ω—ñ

–°—å–æ–≥–æ–¥–Ω—ñ –º–∏ –Ω–µ –ø–∏—à–µ–º–æ –Ω–æ–≤—É —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å. –ú–∏ —Ä–æ–±–∏–º–æ —ñ—Å–Ω—É—é—á—É ‚Äî **—à–≤–∏–¥–∫–æ—é**.
–í —ñ–Ω–∂–µ–Ω–µ—Ä—ñ—ó —î –ø—Ä–∞–≤–∏–ª–æ: *"Make it work, make it right, make it fast"*. –í–∏ –≤–∂–µ –≤–º—ñ—î—Ç–µ —Ä–æ–±–∏—Ç–∏ "work". –°—å–æ–≥–æ–¥–Ω—ñ —á–∞—Å –¥–ª—è "fast".

**–õ–µ–≥–µ–Ω–¥–∞:** –í–∏ ‚Äî Backend Engineer —É –ø–æ–≥–æ–¥–Ω–æ–º—É —Å—Ç–∞—Ä—Ç–∞–ø—ñ. –í–∞—à–∞ –º–µ—Ä–µ–∂–∞ –º–µ—Ç–µ–æ—Å—Ç–∞–Ω—Ü—ñ–π –Ω–∞–¥—Å–∏–ª–∞—î 10 –º—ñ–ª—å–π–æ–Ω—ñ–≤ –∑–∞–ø–∏—Å—ñ–≤ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏ —â–æ–¥–Ω—è. –í–∞—à –ø–æ—Ç–æ—á–Ω–∏–π —Å–∫—Ä–∏–ø—Ç –æ–±—Ä–æ–±–ª—è—î —Ü–µ 2 —Ö–≤–∏–ª–∏–Ω–∏. –¶–µ –∑–∞–Ω–∞–¥—Ç–æ –¥–æ–≤–≥–æ.
**–ó–∞–¥–∞—á–∞:** –ü—Ä–∏—Å–∫–æ—Ä–∏—Ç–∏ –æ–±—Ä–æ–±–∫—É –¥–∞–Ω–∏—Ö —É **10-50 —Ä–∞–∑—ñ–≤**.

## –ï–∫—Å–ø—Ä–µ—Å-–æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è

1.  –°–∫—ñ–ª—å–∫–∏ —á–∞—Å—É (–ø—Ä–∏–±–ª–∏–∑–Ω–æ) –∑–∞–π–º–∞—î –≤–∏–¥—ñ–ª–µ–Ω–Ω—è –ø–∞–º'—è—Ç—ñ (`new`/`malloc`)? –¶–µ "–¥–µ—à–µ–≤–∞" —á–∏ "–¥–æ—Ä–æ–≥–∞" –æ–ø–µ—Ä–∞—Ü—ñ—è?
2.  –©–æ —à–≤–∏–¥—à–µ –ø—Ä–æ—Ü–µ—Å–æ—Ä –æ–±—Ä–æ–±–ª—è—î: `int` —á–∏ `float`?
3.  –Ø–∫—â–æ —É –Ω–∞—Å —î —Ñ–∞–π–ª –Ω–∞ 1 –ì–ë, —á–∏ –æ–±–æ–≤'—è–∑–∫–æ–≤–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ –π–æ–≥–æ –≤–µ—Å—å —É RAM, —â–æ–± –ø—Ä–æ—á–∏—Ç–∞—Ç–∏?

<details markdown="1">
<summary>–í—ñ–¥–ø–æ–≤—ñ–¥—ñ (–Ü–Ω–∂–µ–Ω–µ—Ä–Ω–∏–π –ø–æ–≥–ª—è–¥)</summary>

1.  **–î–æ—Ä–æ–≥–∞.** –¶–µ —Å–∏—Å—Ç–µ–º–Ω–∏–π –≤–∏–∫–ª–∏–∫ –¥–æ –û–°. –Ø–∫—â–æ —Ä–æ–±–∏—Ç–∏ —Ü–µ –º—ñ–ª—å–π–æ–Ω —Ä–∞–∑—ñ–≤ —É —Ü–∏–∫–ª—ñ ‚Äî –ø—Ä–æ–≥—Ä–∞–º–∞ "–ø–æ–º–∏—Ä–∞—î".
2.  **Int –∑–Ω–∞—á–Ω–æ —à–≤–∏–¥—à–µ.** –û–ø–µ—Ä–∞—Ü—ñ—ó –∑ –ø–ª–∞–≤–∞—é—á–æ—é –∫—Ä–∞–ø–∫–æ—é —Å–∫–ª–∞–¥–Ω—ñ—à—ñ –¥–ª—è CPU, –ø–ª—é—Å –º–æ–∂–ª–∏–≤—ñ –ø–æ–º–∏–ª–∫–∏ —Ç–æ—á–Ω–æ—Å—Ç—ñ.
3.  **–ù—ñ.** –ú–∏ –º–æ–∂–µ–º–æ —á–∏—Ç–∞—Ç–∏ —à–º–∞—Ç–∫–∞–º–∏ (–±—É—Ñ–µ—Ä–∏–∑–∞—Ü—ñ—è) –∞–±–æ –≤—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏ —Ñ–∞–π–ª —É –ø–∞–º'—è—Ç—å (Memory Mapping).

</details>

---

## –ß–∞—Å—Ç–∏–Ω–∞ 0: –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–∞–Ω–∏—Ö (Setup)

–ù–∞–º –ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–∞–Ω—ñ. –ë–∞–≥–∞—Ç–æ –¥–∞–Ω–∏—Ö. –°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª `generator.cpp` —ñ –∑–≥–µ–Ω–µ—Ä—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤–∏–π —Ñ–∞–π–ª `measurements.txt` –Ω–∞ 10 –º–ª–Ω —Ä—è–¥–∫—ñ–≤.

–§–æ—Ä–º–∞—Ç: `StationName;Temperature` (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: `Kyiv;12.5`).

<details markdown="1">
<summary>–ö–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ (Copy/Paste)</summary>

```cpp
#include <iostream>
#include <fstream>
#include <vector>
#include <random>
#include <iomanip>

int main() {
    const int N_ROWS = 10'000'000; // 10 –º—ñ–ª—å–π–æ–Ω—ñ–≤
    std::vector<std::string> stations = {"Kyiv", "Lviv", "Odesa", "Kharkiv", "Dnipro", "London", "Paris", "Berlin", "Tokyo", "NewYork"};
    
    std::ofstream file("measurements.txt");
    std::mt19937 rng(42);
    std::uniform_int_distribution<int> dist_station(0, stations.size() - 1);
    std::uniform_real_distribution<float> dist_temp(-99.9, 99.9);

    std::cout << "Generating " << N_ROWS << " rows..." << std::endl;
    for(int i = 0; i < N_ROWS; ++i) {
        file << stations[dist_station(rng)] << ";" 
             << std::fixed << std::setprecision(1) << dist_temp(rng) << "\n";
    }
    std::cout << "Done!" << std::endl;
    return 0;
}

```

</details>

---

## –ß–∞—Å—Ç–∏–Ω–∞ 1: The Baseline (–Ø–∫ –ø–∏—à–µ Junior)

–ù–∞–ø–∏—à–µ–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è: `ifstream`, `std::string`, `std::map`.
–ú–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ `Timer` (–¥–∏–≤. –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –ª–µ–∫—Ü—ñ—ó) –¥–ª—è –∑–∞–º—ñ—Ä—É.

**–ü—Ä–æ–±–ª–µ–º–∏ —Ü—å–æ–≥–æ –∫–æ–¥—É:**

1. **Allocation Hell:** –ö–æ–∂–µ–Ω `getline` —Å—Ç–≤–æ—Ä—é—î –Ω–æ–≤—É `std::string` (–≤–∏–¥—ñ–ª—è—î –ø–∞–º'—è—Ç—å).
2. **Copy Hell:** –ú–∏ –∫–æ–ø—ñ—é—î–º–æ –¥–∞–Ω—ñ –∑ —Ñ–∞–π–ª—É –≤ –±—É—Ñ–µ—Ä, –∑ –±—É—Ñ–µ—Ä–∞ –≤ string, –∑—ñ string —É map.
3. **Float Parsing:** `std::stof` ‚Äî —Ü–µ –ø–æ–≤—ñ–ª—å–Ω–æ.

> ‚è± **–ó–∞–≤–¥–∞–Ω–Ω—è:** –ó–∞–ø—É—Å—Ç—ñ—Ç—å, –∑–∞–ø–∏—à—ñ—Ç—å —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è. –¶–µ –≤–∞—à Baseline. (–ù–∞–ø—Ä–∏–∫–ª–∞–¥: 15.4 —Å–µ–∫).

---

## –ß–∞—Å—Ç–∏–Ω–∞ 2: –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –ø–∞–º'—è—Ç—ñ (Zero Copy & StringView)

–ù–∞–π—à–≤–∏–¥—à–∏–π –∫–æ–¥ ‚Äî —Ç–æ–π, —è–∫–∏–π –Ω–µ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è. –ù–∞–π—à–≤–∏–¥—à–∞ –∞–ª–æ–∫–∞—Ü—ñ—è –ø–∞–º'—è—Ç—ñ ‚Äî —Ç–∞, —è–∫–æ—ó –Ω–µ –±—É–ª–æ.

–ú–∏ –∑–∞–º—ñ–Ω–∏–º–æ `std::string` –Ω–∞ `std::string_view`.
`string_view` ‚Äî —Ü–µ –ø—Ä–æ—Å—Ç–æ "–ø–æ–≥–ª—è–¥" –Ω–∞ –ø–∞–º'—è—Ç—å. –í—ñ–Ω –Ω–µ –≤–æ–ª–æ–¥—ñ—î –¥–∞–Ω–∏–º–∏, –≤—ñ–Ω –ø—Ä–æ—Å—Ç–æ –∑–Ω–∞—î "–ø–æ—á–∞—Ç–æ–∫" —ñ "–¥–æ–≤–∂–∏–Ω—É".

**–ê–ª–µ —î –Ω—é–∞–Ω—Å:** –©–æ–± –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ `string_view`, –¥–∞–Ω—ñ –º—É—Å—è—Ç—å –∂–∏—Ç–∏ –¥–µ—Å—å —É –ø–∞–º'—è—Ç—ñ. –ú–∏ –Ω–µ –º–æ–∂–µ–º–æ —á–∏—Ç–∞—Ç–∏ –ø–æ –æ–¥–Ω–æ–º—É —Ä—è–¥–∫—É. –ú–∏ –º—É—Å–∏–º–æ –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ **–≤–µ–ª–∏–∫–∏–π –±–ª–æ–∫** (Chunk) —É –ø–∞–º'—è—Ç—å —ñ "–Ω–∞—Ä—ñ–∑–∞—Ç–∏" –π–æ–≥–æ —á–µ—Ä–µ–∑ `string_view`.

### –ê–ª–≥–æ—Ä–∏—Ç–º "Chunk Reader":

1. –í–∏–¥—ñ–ª–∏—Ç–∏ –≤–µ–ª–∏–∫–∏–π –±—É—Ñ–µ—Ä (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 1 –ú–ë) -> `std::vector<char> buffer(1024*1024)`.
2. –ß–∏—Ç–∞—î–º–æ —à–º–∞—Ç–æ–∫ —Ñ–∞–π–ª—É: `file.read(buffer.data(), buffer.size())`.
3. –ü—Ä–æ—Ö–æ–¥–∏–º–æ –ø–æ –±—É—Ñ–µ—Ä—É, —à—É–∫–∞—î–º–æ `\n`.
4. –°—Ç–≤–æ—Ä—é—î–º–æ `string_view` –∑–∞–º—ñ—Å—Ç—å –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è.

<details markdown="1">
<summary>–ü—ñ–¥–∫–∞–∑–∫–∞: –Ø–∫ –ø—Ä–∞—Ü—é—î string_view</summary>

```cpp
// BAD (Allocation + Copy)
std::string name = line.substr(0, pos); 

// GOOD (Zero Copy)
// name_view –ø—Ä–æ—Å—Ç–æ –≤–∫–∞–∑—É—î –Ω–∞ —Ç—ñ –∂ –±–∞–π—Ç–∏, —â–æ —ñ buffer
std::string_view name_view(buffer.data() + start, length); 

```

</details>

---

## –ß–∞—Å—Ç–∏–Ω–∞ 3: –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ —Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ—ó –∫—Ä–∞–ø–∫–∏ (Integer Math)

–ü–æ–¥–∏–≤—ñ—Ç—å—Å—è –Ω–∞ –Ω–∞—à—ñ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏: `-10.5`, `23.1`. –£ –Ω–∏—Ö –∑–∞–≤–∂–¥–∏ 1 –∑–Ω–∞–∫ –ø—ñ—Å–ª—è –∫–æ–º–∏.
–ö–æ–º–ø'—é—Ç–µ—Ä—É –≤–∞–∂–∫–æ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –∑ `float`. –ê–ª–µ –π–æ–º—É –¥—É–∂–µ –ª–µ–≥–∫–æ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –∑ `int`.

**–Ü–¥–µ—è:** –ó–±–µ—Ä—ñ–≥–∞—Ç–∏ `23.1` —è–∫ `231`.
–ö–æ–ª–∏ –º–∏ —á–∏—Ç–∞—î–º–æ —á–∏—Å–ª–æ:

1. –Ü–≥–Ω–æ—Ä—É—î–º–æ –∫—Ä–∞–ø–∫—É `.`
2. –ß–∏—Ç–∞—î–º–æ —è–∫ —Ü—ñ–ª–µ —á–∏—Å–ª–æ.
3. –í –∫—ñ–Ω—Ü—ñ –ø—Ä–æ—Å—Ç–æ –¥—ñ–ª–∏–º–æ –Ω–∞ 10 (—Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ –≤–∏–≤–æ–¥—ñ!).

**–í–∞—à–µ –∑–∞–≤–¥–∞–Ω–Ω—è:** –ù–∞–ø–∏—Å–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é `int parse_temp(string_view s)`, —è–∫–∞ –≤—Ä—É—á–Ω—É –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î —Ç–µ–∫—Å—Ç –Ω–∞ `int`, —ñ–≥–Ω–æ—Ä—É—é—á–∏ –∫—Ä–∞–ø–∫—É. –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `std::stof` –∞–±–æ `stringstream`.

```cpp
// –ü—Ä–∏–∫–ª–∞–¥ –ª–æ–≥—ñ–∫–∏
// Text: "12.3" -> Int: 123
int custom_atoi(const char* p, const char* end) {
    int res = 0;
    bool neg = (*p == '-');
    if (neg) p++;
    for (; p != end; ++p) {
        if (*p == '.') continue; // Skip dot
        res = res * 10 + (*p - '0');
    }
    return neg ? -res : res;
}

```

---

## –ß–∞—Å—Ç–∏–Ω–∞ 4: –§—ñ–Ω–∞–ª—å–Ω–∏–π –±—ñ–π (Map vs Unordered Map)

–£ –Ω–∞—Å –æ–±–º–µ–∂–µ–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å—Ç–∞–Ω—Ü—ñ–π (~10-100 —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö).

1. –°–ø—Ä–æ–±—É–π—Ç–µ `std::map` (–¥–µ—Ä–µ–≤–æ).
2. –°–ø—Ä–æ–±—É–π—Ç–µ `std::unordered_map` (—Ö–µ—à-—Ç–∞–±–ª–∏—Ü—è).
3. **–ë–æ–Ω—É—Å –¥–ª—è –ø—Ä–æ—Ñ—ñ:** –û—Å–∫—ñ–ª—å–∫–∏ –Ω–∞–∑–≤–∏ —Å—Ç–∞–Ω—Ü—ñ–π –ø–æ–≤—Ç–æ—Ä—é—é—Ç—å—Å—è, —á–∏ –º–æ–∂–µ–º–æ –º–∏ —É–Ω–∏–∫–Ω—É—Ç–∏ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è `std::string` —è–∫ –∫–ª—é—á–∞? (–ü—ñ–¥–∫–∞–∑–∫–∞: Perfect Hashing –∞–±–æ –ø—Ä–æ—Å—Ç–æ –º–∞—Å–∏–≤, —è–∫—â–æ —ñ–Ω–¥–µ–∫—Å–∏ —Å—Ç–∞–Ω—Ü—ñ–π –≤—ñ–¥–æ–º—ñ).

---

## –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ (KPI)

–í–∏ –º–∞—î—Ç–µ –∑–∞–ø–æ–≤–Ω–∏—Ç–∏ —Ü—é —Ç–∞–±–ª–∏—Ü—é —Å–≤–æ—ó–º–∏ –¥–∞–Ω–∏–º–∏:

| –ú–µ—Ç–æ–¥ | –ß–∞—Å (—Å–µ–∫) | Speedup (X —Ä–∞–∑—ñ–≤) |
| --- | --- | --- |
| Baseline (getline + string + stof) | 15.0s | 1x |
| Optimization 1 (string_view) | ... | ... |
| Optimization 2 (Integer math) | ... | ... |
| **Target** | **< 1.0s** | **> 15x** |

## ü§î –î–∞–≤–∞–π—Ç–µ –ø–æ–º—ñ—Ä–∫—É—î–º–æ

1. –ß–æ–º—É –º–∏ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–ª–∏ `mmap`? –£ —è–∫–∏—Ö –≤–∏–ø–∞–¥–∫–∞—Ö `mmap` –±—É–¥–µ –Ω–µ–±–µ–∑–ø–µ—á–Ω–∏–º? (–ü—ñ–¥–∫–∞–∑–∫–∞: 32-–±—ñ—Ç–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ –∞–±–æ —Ñ–∞–π–ª–∏ –±—ñ–ª—å—à—ñ –∑–∞ RAM).
2. –ß–æ–º—É, –∫–æ–ª–∏ –º–∏ –∑–∞–º—ñ–Ω–∏–ª–∏ `float` –Ω–∞ `int`, –ø—Ä–æ–≥—Ä–∞–º–∞ –ø—Ä–∏—Å–∫–æ—Ä–∏–ª–∞—Å—å? –°–ø—Ä–∞–≤–∞ —Ç—ñ–ª—å–∫–∏ –≤ –º–∞—Ç–µ–º–∞—Ç–∏—Ü—ñ, —á–∏ —â–µ –π –≤ –ø–∞—Ä—Å–∏–Ω–≥—É —Ç–µ–∫—Å—Ç—É?
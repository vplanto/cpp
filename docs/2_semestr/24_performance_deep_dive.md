# –õ–µ–∫—Ü—ñ—è 24: Performance Deep Dive ‚Äî –ü—Ä–æ—Ñ—ñ–ª—é–≤–∞–Ω–Ω—è —Ç–∞ –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è

[‚Üê –õ–µ–∫—Ü—ñ—è 23](23_optimization_dp.md) | [Index](index.md)

## –ú–µ—Ç–∞

–ù–∞–≤—á–∏—Ç–∏—Å—è **–≤–∏–º—ñ—Ä—é–≤–∞—Ç–∏** –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –∫–æ–¥—É, –∑–Ω–∞—Ö–æ–¥–∏—Ç–∏ –≤—É–∑—å–∫—ñ –º—ñ—Å—Ü—è —Ç–∞ –æ–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏ —ó—Ö. –†–æ–∑—É–º—ñ—Ç–∏, —è–∫ –∑–∞–ª—ñ–∑–æ (CPU, –∫–µ—à, –ø–∞–º'—è—Ç—å) –≤–ø–ª–∏–≤–∞—î –Ω–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å –ø—Ä–æ–≥—Ä–∞–º. –í–º—ñ—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—é–≤–∞–Ω–Ω—è.

## –ï–∫—Å–ø—Ä–µ—Å-–æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è

1. –©–æ —à–≤–∏–¥—à–µ: –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ 1 –ú–ë –¥–∞–Ω–∏—Ö –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ —á–∏ –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ 1 –ú–ë –¥–∞–Ω–∏—Ö —Å—Ç—Ä–∏–±–∫–∞–º–∏ –ø–æ 4 –±–∞–π—Ç–∏ —É –≤–∏–ø–∞–¥–∫–æ–≤–∏—Ö –º—ñ—Å—Ü—è—Ö?
2. –Ø–∫—â–æ –≤–∞—à–∞ –ø—Ä–æ–≥—Ä–∞–º–∞ –ø—Ä–∞—Ü—é—î 10 —Å–µ–∫—É–Ω–¥, –∞–ª–µ –≤–∏ –Ω–µ –∑–Ω–∞—î—Ç–µ, –¥–µ —Å–∞–º–µ –≤–æ–Ω–∞ –≤–∏—Ç—Ä–∞—á–∞—î —á–∞—Å, —â–æ —Ä–æ–±–∏—Ç–∏ –ø–µ—Ä—à–∏–º?
3. –ß–∏ –≤–∞—Ä—Ç–æ –æ–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏ –∫–æ–¥ –¥–æ —Ç–æ–≥–æ, —è–∫ –≤–∏ –≤–∏–º—ñ—Ä—è–ª–∏ –π–æ–≥–æ —à–≤–∏–¥–∫—ñ—Å—Ç—å?

<details markdown="1">
<summary>–Ü–Ω–∂–µ–Ω–µ—Ä–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å</summary>

1. **–ü–æ—Å–ª—ñ–¥–æ–≤–Ω–æ —É ~100 —Ä–∞–∑—ñ–≤ —à–≤–∏–¥—à–µ.** CPU –ø–µ—Ä–µ–¥–±–∞—á–∞—î –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–µ —á–∏—Ç–∞–Ω–Ω—è —ñ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î –¥–∞–Ω—ñ –≤ –∫–µ—à –Ω–∞–ø–µ—Ä–µ–¥ (prefetching). –í–∏–ø–∞–¥–∫–æ–≤–∏–π –¥–æ—Å—Ç—É–ø –≤–∏–∫–ª–∏–∫–∞—î cache misses.
2. **–í–∏–º—ñ—Ä—è—Ç–∏ —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–∂–Ω–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –ø—Ä–æ—Ñ–∞–π–ª–µ—Ä–∞ (perf, gprof). –û–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏ —Ç—Ä–µ–±–∞ —Ç—ñ–ª—å–∫–∏ –Ω–∞–π–ø–æ–≤—ñ–ª—å–Ω—ñ—à—ñ 20% –∫–æ–¥—É (Pareto principle).
3. **–ù—ñ.** "Premature optimization is the root of all evil" (Knuth). –°–ø–æ—á–∞—Ç–∫—É –Ω–∞–ø–∏—à—ñ—Ç—å –∫–æ–¥, —â–æ –ø—Ä–∞—Ü—é—î. –ü–æ—Ç—ñ–º –≤–∏–º—ñ—Ä—è–π—Ç–µ. –ü–æ—Ç—ñ–º –æ–ø—Ç–∏–º—ñ–∑—É–π—Ç–µ —Ç—ñ–ª—å–∫–∏ —Ç–∞–º, –¥–µ —Ü–µ –¥—ñ–π—Å–Ω–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ.

</details>

---

## –ß–∞—Å—Ç–∏–Ω–∞ 1: –†–µ–∞–ª—å–Ω—ñ—Å—Ç—å –∑–∞–ª—ñ–∑–∞ ‚Äî Memory Hierarchy

### –©–æ —Å—Ç—É–¥–µ–Ω—Ç–∏ –¥—É–º–∞—é—Ç—å:
```
CPU ‚Üê‚Üí RAM
```

### –©–æ –Ω–∞—Å–ø—Ä–∞–≤–¥—ñ:
```
CPU ‚Üê‚Üí Registers ‚Üê‚Üí L1 Cache ‚Üê‚Üí L2 Cache ‚Üê‚Üí L3 Cache ‚Üê‚Üí RAM ‚Üê‚Üí Disk
```

### –ê–Ω–∞–ª–æ–≥—ñ—è –≤—ñ–¥—Å—Ç–∞–Ω–µ–π (Human Scale)

–Ø–∫—â–æ **1 CPU —Ü–∏–∫–ª (0.3 –Ω—Å) = 1 —Å–µ–∫—É–Ω–¥–∞** –∂–∏—Ç—Ç—è –ª—é–¥–∏–Ω–∏:

| –ü–æ–¥—ñ—è | –†–µ–∞–ª—å–Ω–∏–π —á–∞—Å | –õ—é–¥—Å—å–∫–∏–π –º–∞—Å—à—Ç–∞–± |
|-------|--------------|------------------|
| **1 CPU Cycle** | 0.3 ns | **1 —Å–µ–∫—É–Ω–¥–∞** |
| **L1 Cache** | 1 ns | **3 —Å–µ–∫—É–Ω–¥–∏** (–≤–∑—è—Ç–∏ –∫–Ω–∏–≥—É –∑—ñ —Å—Ç–æ–ª—É) |
| **L2 Cache** | 4 ns | **12 —Å–µ–∫—É–Ω–¥** (–¥—ñ–π—Ç–∏ –¥–æ –ø–æ–ª–∏—Ü—ñ) |
| **L3 Cache** | 10 ns | **30 —Å–µ–∫—É–Ω–¥** (—Å–ø—É—Å—Ç–∏—Ç–∏—Å—è —Å—Ö–æ–¥–∞–º–∏) |
| **RAM Access** | 100 ns | **5 —Ö–≤–∏–ª–∏–Ω** (—Å—Ö–æ–¥–∏—Ç–∏ –∑–∞ –∫–∞–≤–æ—é) |
| **SSD Read** | 100 Œºs | **4 –¥–Ω—ñ** (–ø–æ—ó–∑–¥–∫–∞ –ö–∏—ó–≤-–û–¥–µ—Å–∞) |
| **HDD Read** | 10 ms | **1 —Ä—ñ–∫** (–ø—ñ—à–∞ –ø–æ–¥–æ—Ä–æ–∂ –Ω–∞–≤–∫–æ–ª–æ —Å–≤—ñ—Ç—É) |

**–í–∏—Å–Ω–æ–≤–æ–∫:** –ö–æ–∂–µ–Ω —Ä–∞–∑, –∫–æ–ª–∏ CPU —á–µ–∫–∞—î –¥–∞–Ω—ñ –∑ RAM, –≤—ñ–Ω "–ø—ñ–¥–µ –ø–∏—Ç–∏ –∫–∞–≤—É –Ω–∞ 5 —Ö–≤–∏–ª–∏–Ω". –û—Å—å —á–æ–º—É `std::vector` (—Å—É—Ü—ñ–ª—å–Ω–∞ –ø–∞–º'—è—Ç—å) –º–∞–π–∂–µ –∑–∞–≤–∂–¥–∏ —à–≤–∏–¥—à–∏–π –∑–∞ `std::list` (—Ä–æ–∑–∫–∏–¥–∞–Ω—ñ –≤—É–∑–ª–∏).

---

## –ß–∞—Å—Ç–∏–Ω–∞ 2: –í–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è ‚Äî Timer Class (–¥–ª—è –ø–æ—á–∞—Ç–∫—ñ–≤—Ü—ñ–≤)

### –ö—Ä–æ–∫ 1: –°—Ç–≤–æ—Ä—ñ—Ç—å timer.h

```cpp
// timer.h - –ö–ª–∞—Å –¥–ª—è –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è —á–∞—Å—É –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É
#pragma once
#include <chrono>
#include <iostream>
#include <string>

class Timer {
private:
    std::chrono::time_point<std::chrono::high_resolution_clock> start_time;
    std::string name;

public:
    // –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä: –∑–∞–ø–∞–º'—è—Ç–æ–≤—É—î —á–∞—Å –ø–æ—á–∞—Ç–∫—É
    Timer(const std::string& timer_name = "Timer") : name(timer_name) {
        start_time = std::chrono::high_resolution_clock::now();
    }
    
    // –î–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä: –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–≤–æ–¥–∏—Ç—å —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
    ~Timer() {
        auto end_time = std::chrono::high_resolution_clock::now();
        auto duration = std::chrono::duration_cast<std::chrono::milliseconds>(
            end_time - start_time);
        
        std::cout << "[" << name << "] " << duration.count() << " ms\\n";
    }
    
    // –†—É—á–Ω–µ –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è –±–µ–∑ –∞–≤—Ç–æ–≤–∏–≤–æ–¥—É
    long long elapsed_ms() const {
        auto current = std::chrono::high_resolution_clock::now();
        return std::chrono::duration_cast<std::chrono::milliseconds>(
            current - start_time).count();
    }
};
```

### –ö—Ä–æ–∫ 2: –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

```cpp
#include "timer.h"
#include <vector>

int main() {
    {
        Timer t("Vector fill");
        std::vector<int> vec;
        for (int i = 0; i < 10'000'000; i++) {
            vec.push_back(i);
        }
    } // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–≤–µ–¥–µ: [Vector fill] 250 ms
    
    {
        Timer t("Vector with reserve");
        std::vector<int> vec;
        vec.reserve(10'000'000); // –†–µ–∑–µ—Ä–≤—É—î–º–æ –ø–∞–º'—è—Ç—å –∑–∞–∑–¥–∞–ª–µ–≥—ñ–¥—å
        for (int i = 0; i < 10'000'000; i++) {
            vec.push_back(i);
        }
    } // [Vector with reserve] 80 ms ‚Äî 3x —à–≤–∏–¥—à–µ!
}
```

**–ß–æ–º—É —à–≤–∏–¥—à–µ –∑ `reserve()`?** –ë–µ–∑ —Ä–µ–∑–µ—Ä–≤—É–≤–∞–Ω–Ω—è –≤–µ–∫—Ç–æ—Ä –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–æ –ø–µ—Ä–µ–≤–∏–¥—ñ–ª—è—î –ø–∞–º'—è—Ç—å —ñ –∫–æ–ø—ñ—é—î –≤—Å—ñ –µ–ª–µ–º–µ–Ω—Ç–∏. –ó `reserve()` –ø–∞–º'—è—Ç—å –≤–∏–¥—ñ–ª—è—î—Ç—å—Å—è –æ–¥–∏–Ω —Ä–∞–∑.

---

## –ß–∞—Å—Ç–∏–Ω–∞ 3: Compiler Flags ‚Äî –¢—É—Ä–±–æ –¥–ª—è –≤–∞—à–æ–≥–æ –∫–æ–¥—É

### –©–æ —Ç–∞–∫–µ compiler flags?

–¶–µ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –∫–æ–º–ø—ñ–ª—è—Ç–æ—Ä—É, **—è–∫** –ø–µ—Ä–µ—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –≤–∞—à –∫–æ–¥ —É –º–∞—à–∏–Ω–Ω–∏–π –∫–æ–¥.

### –û—Å–Ω–æ–≤–Ω—ñ –ø—Ä–∞–ø–æ—Ä—Ü—ñ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó

```bash
# 1. Debug build (–±–µ–∑ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ–π, –∑—Ä—É—á–Ω–æ –¥–ª—è –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è)
g++ -g -O0 my_program.cpp -o my_program_debug

# 2. Release build (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å)
g++ -O3 -march=native my_program.cpp -o my_program_fast

# 3. –ó –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è–º–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –∑–∞–≤–∂–¥–∏)
g++ -Wall -Wextra -O3 my_program.cpp -o my_program
```

### –¢–∞–±–ª–∏—Ü—è –ø—Ä–∞–ø–æ—Ä—Ü—ñ–≤

| –ü—Ä–∞–ø–æ—Ä–µ—Ü—å | –©–æ —Ä–æ–±–∏—Ç—å | –ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ |
|-----------|-----------|---------------------|
| `-g` | –î–æ–¥–∞—î debug —Å–∏–º–≤–æ–ª–∏ | –†–æ–∑—Ä–æ–±–∫–∞, –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è –∑ gdb |
| `-O0` | –ë–µ–∑ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ–π | Debug (–ø–µ—Ä–µ–¥–±–∞—á—É–≤–∞–Ω–∞ –ø–æ–≤–µ–¥—ñ–Ω–∫–∞) |
| `-O1` | –ë–∞–∑–æ–≤–∞ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è | –ü–µ—Ä—à–∏–π –∫—Ä–æ–∫ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó |
| `-O2` | –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∞ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è | **Production builds** |
| `-O3` | –ê–≥—Ä–µ—Å–∏–≤–Ω–∞ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è | Performance-critical –∫–æ–¥ |
| `-march=native` | –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –≤–∞—à–æ–≥–æ CPU | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å |
| `-Wall -Wextra` | –£–≤—ñ–º–∫–Ω—É—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è | **–ó–∞–≤–∂–¥–∏** |
| `-std=c++17` | –°—Ç–∞–Ω–¥–∞—Ä—Ç C++ | –ó–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –ø—Ä–æ–µ–∫—Ç—É |

### –ü—Ä–∏–∫–ª–∞–¥ —Ä—ñ–∑–Ω–∏—Ü—ñ

```cpp
#include "timer.h"
#include <cmath>

int main() {
    Timer t;
    double sum = 0;
    for (int i = 0; i < 100'000'000; i++) {
        sum += std::sqrt(i);
    }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç–∏:**
- –ö–æ–º–ø—ñ–ª—è—Ü—ñ—è –∑ `-O0`: **5000 ms**
- –ö–æ–º–ø—ñ–ª—è—Ü—ñ—è –∑ `-O3`: **800 ms** (6x —à–≤–∏–¥—à–µ!)
- –ö–æ–º–ø—ñ–ª—è—Ü—ñ—è –∑ `-O3 -march=native`: **600 ms** (8x —à–≤–∏–¥—à–µ!)

---

## –ß–∞—Å—Ç–∏–Ω–∞ 4: Makefile –¥–ª—è –ø–æ—á–∞—Ç–∫—ñ–≤—Ü—ñ–≤

### –ö—Ä–æ–∫ 1: –°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª Makefile

```makefile
# –ö–æ–º–ø—ñ–ª—è—Ç–æ—Ä
CXX = g++

# –ü—Ä–∞–ø–æ—Ä—Ü—ñ –¥–ª—è –≤—Å—ñ—Ö –∑–±—ñ—Ä–æ–∫
CXXFLAGS = -std=c++17 -Wall -Wextra

# –í–∏—Ö—ñ–¥–Ω–∏–π —Ñ–∞–π–ª
TARGET = program

# Debug –∑–±—ñ—Ä–∫–∞
debug: CXXFLAGS += -g -O0
debug: $(TARGET)

# Release –∑–±—ñ—Ä–∫–∞
release: CXXFLAGS += -O3 -march=native
release: $(TARGET)

# –ö–æ–º–ø—ñ–ª—è—Ü—ñ—è
$(TARGET): main.cpp
\t$(CXX) $(CXXFLAGS) main.cpp -o $(TARGET)

# –û—á–∏—â–µ–Ω–Ω—è
clean:
\trm -f $(TARGET)

.PHONY: debug release clean
```

### –ö—Ä–æ–∫ 2: –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

```bash
# Debug –∑–±—ñ—Ä–∫–∞ (–¥–ª—è —Ä–æ–∑—Ä–æ–±–∫–∏)
make debug
./program

# Release –∑–±—ñ—Ä–∫–∞ (–¥–ª—è –≤–∏–º—ñ—Ä—é–≤–∞–Ω—å)
make release
./program

# –û—á–∏—Å—Ç–∏—Ç–∏
make clean
```

---

## –ß–∞—Å—Ç–∏–Ω–∞ 5: Profiling –∑ perf (Linux)

### –©–æ —Ç–∞–∫–µ perf?

`perf` ‚Äî —Ü–µ –ø—Ä–æ—Ñ–∞–π–ª–µ—Ä –≤—ñ–¥ Linux Kernel, —è–∫–∏–π –ø–æ–∫–∞–∑—É—î, –¥–µ –≤–∞—à–∞ –ø—Ä–æ–≥—Ä–∞–º–∞ –≤–∏—Ç—Ä–∞—á–∞—î —á–∞—Å.

### –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è

**Ubuntu/Debian:**
```bash
sudo apt-get update
sudo apt-get install linux-tools-common linux-tools-generic
```

**WSL2:**
```bash
# perf –º–∞—î –æ–±–º–µ–∂–µ–Ω–Ω—è –Ω–∞ WSL2
# –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ std::chrono –∞–±–æ Docker
```

**Docker (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –¥–ª—è –æ–¥–Ω–∞–∫–æ–≤–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞):**
```bash
docker run -it --privileged ubuntu:22.04 /bin/bash
apt-get update && apt-get install -y build-essential linux-tools-generic
```

### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è perf

#### –°—Ü–µ–Ω–∞—Ä—ñ–π 1: –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

```bash
# –ö–æ–º–ø—ñ–ª—é—î–º–æ –∑ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è–º–∏
g++ -O3 -g my_program.cpp -o my_program

# –ó–∞–ø—É—Å–∫–∞—î–º–æ –∑ perf
perf stat -d ./my_program
```

**–©–æ –¥–∏–≤–∏—Ç–∏—Å—è —É –≤–∏–≤–æ–¥—ñ:**
- **task-clock**: –°–∫—ñ–ª—å–∫–∏ —á–∞—Å—É CPU –ø—Ä–∞—Ü—é–≤–∞–≤ (ms)
- **instructions**: –°–∫—ñ–ª—å–∫–∏ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π –≤–∏–∫–æ–Ω–∞–Ω–æ
- **IPC (instructions per cycle)**: –Ø–∫—â–æ < 1.0 ‚Üí CPU —á–µ–∫–∞—î –ø–∞–º'—è—Ç—å
- **L1-dcache-load-misses**: –ü—Ä–æ–º–∞—Ö–∏ –∫–µ—à—É (—á–∏–º –º–µ–Ω—à–µ, —Ç–∏–º –∫—Ä–∞—â–µ)

#### –°—Ü–µ–Ω–∞—Ä—ñ–π 2: –Ø–∫—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –ø–æ–≤—ñ–ª—å–Ω—ñ?

```bash
# –ó–∞–ø–∏—Å—É—î–º–æ –ø—Ä–æ—Ñ—ñ–ª—å
perf record -g ./my_program

# –î–∏–≤–∏–º–æ—Å—è –∑–≤—ñ—Ç
perf report
```

**–í–∏–≤—ñ–¥ –ø–æ–∫–∞–∂–µ:**
```
Overhead  Command  Shared Object     Symbol
  45.00%  program  program           [.] std::vector::push_back
  30.00%  program  program           [.] compute_sum
  15.00%  program  libc.so.6         [.] malloc
```

**–Ü–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü—ñ—è:** 45% —á–∞—Å—É –π–¥–µ –Ω–∞ `push_back` ‚Üí —Ç—Ä–µ–±–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ `reserve()`.

---

## –ß–∞—Å—Ç–∏–Ω–∞ 6: Performance Anti-Patterns

### 1. Copy Hell (–∑–∞–π–≤—ñ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è)

**BAD:**
```cpp
void process(std::string data) {  // –ö–æ–ø—ñ—é—î–º–æ –≤—Å—é —Å—Ç—Ä–æ–∫—É!
    // ...
}

std::string big_text = load_file();  // 10 MB
process(big_text);  // –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è 10 MB
```

**GOOD:**
```cpp
void process(const std::string& data) {  // –ü–µ—Ä–µ–¥–∞—î–º–æ –ø–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—é
    // ...
}

// –ê–±–æ —â–µ –∫—Ä–∞—â–µ (C++17):
void process(std::string_view data) {  // –ë–µ–∑ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –≤–∑–∞–≥–∞–ª—ñ
    // ...
}
```

> **üí° Modern C++ Note: std::string_view (C++17)**
>
> `std::string_view` ‚Äî —Ü–µ –ª–µ–≥–∫–∞ –æ–±–≥–æ—Ä—Ç–∫–∞ –Ω–∞–≤–∫–æ–ª–æ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ—Å—Ç—ñ —Å–∏–º–≤–æ–ª—ñ–≤ (pointer + length).
> 
> **–ß–∏–º –≤—ñ–¥—Ä—ñ–∑–Ω—è—î—Ç—å—Å—è –≤—ñ–¥ `const std::string&`:**
> - `const std::string&` ‚Äî –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —ñ—Å–Ω—É—é—á–∏–π `std::string` –æ–±'—î–∫—Ç
> - `std::string_view` ‚Äî –º–æ–∂–µ –≤–∫–∞–∑—É–≤–∞—Ç–∏ –Ω–∞ **–±—É–¥—å-—è–∫—É** –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å —Å–∏–º–≤–æ–ª—ñ–≤: `std::string`, C-string, —á–∞—Å—Ç–∏–Ω—É –±—É—Ñ–µ—Ä–∞
>
> **–ü–µ—Ä–µ–≤–∞–≥–∏:**
> ```cpp
> std::string str = "Hello, World!";
> std::string_view view1 = str;           // OK
> std::string_view view2 = "C-string";    // OK
> std::string_view view3(str.data(), 5);  // "Hello" ‚Äî –∂–æ–¥–Ω–æ–≥–æ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è!
> ```
>
> **–û–±–µ—Ä–µ–∂–Ω–æ! Lifetime:**
> ```cpp
> std::string_view get_view() {
>     std::string temp = "Danger!";
>     return temp;  // ‚ùå Dangling pointer! temp –∑–Ω–∏—â–µ–Ω–æ
> }
> ```
>
> **–ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏:**
> - –§—É–Ω–∫—Ü—ñ—ó, —â–æ —á–∏—Ç–∞—é—Ç—å —Ä—è–¥–∫–∏ (–Ω–µ –º–æ–¥–∏—Ñ—ñ–∫—É—é—Ç—å)
> - –ü–∞—Ä—Å–∏–Ω–≥ (—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è "–≤—ñ–∫–æ–Ω" —É –≤–µ–ª–∏–∫–∏–π –±—É—Ñ–µ—Ä)
> - Performance-critical –∫–æ–¥ (—É–Ω–∏–∫–∞—î–º–æ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è)
>
> **–ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏:**
> - –Ø–∫—â–æ —Ç—Ä–µ–±–∞ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ —Ä—è–¥–æ–∫ (–≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ `std::string`)
> - –Ø–∫—â–æ lifetime –¥–∞–Ω–∏—Ö –Ω–µ–æ—á–µ–≤–∏–¥–Ω–∏–π

### 2. Allocation Hell (–≤–∏–¥—ñ–ª–µ–Ω–Ω—è –ø–∞–º'—è—Ç—ñ —É —Ü–∏–∫–ª—ñ)

**BAD:**
```cpp
for (int i = 0; i < 1000; i++) {
    std::vector<int> temp;  // –í–∏–¥—ñ–ª—è—î–º–æ –ø–∞–º'—è—Ç—å 1000 —Ä–∞–∑—ñ–≤!
    temp.push_back(i);
}
```

**GOOD:**
```cpp
std::vector<int> temp;
temp.reserve(1000);  // –í–∏–¥—ñ–ª—è—î–º–æ –æ–¥–∏–Ω —Ä–∞–∑

for (int i = 0; i < 1000; i++) {
    temp.clear();  // –û—á–∏—â–∞—î–º–æ, –∞–ª–µ –Ω–µ –∑–≤—ñ–ª—å–Ω—è—î–º–æ –ø–∞–º'—è—Ç—å
    temp.push_back(i);
}
```

### 3. IO Hell (flush –Ω–∞ –∫–æ–∂–µ–Ω —Ä—è–¥–æ–∫)

**BAD:**
```cpp
for (int i = 0; i < 1'000'000; i++) {
    std::cout << i << std::endl;  // endl —Ä–æ–±–∏—Ç—å flush ‚Üí –ø–æ–≤—ñ–ª—å–Ω–æ!
}
```

**GOOD:**
```cpp
for (int i = 0; i < 1'000'000; i++) {
    std::cout << i << '\\n';  // –ü—Ä–æ—Å—Ç–æ –Ω–æ–≤–∏–π —Ä—è–¥–æ–∫
}
// Flush –≤—ñ–¥–±—É–¥–µ—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤ –∫—ñ–Ω—Ü—ñ
```

---

## –ß–∞—Å—Ç–∏–Ω–∞ 7: Workflow –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó

1. **Make it work** ‚Äî —Å–ø–æ—á–∞—Ç–∫—É –Ω–∞–ø–∏—à—ñ—Ç—å –∫–æ–¥, —â–æ –ø—Ä–∞—Ü—é—î –ø—Ä–∞–≤–∏–ª—å–Ω–æ
2. **Measure** ‚Äî –≤–∏–º—ñ—Ä—è–π—Ç–µ –∑ Timer –∞–±–æ perf
3. **Find bottleneck** ‚Äî –∑–Ω–∞–π–¥—ñ—Ç—å –Ω–∞–π–ø–æ–≤—ñ–ª—å–Ω—ñ—à–µ –º—ñ—Å—Ü–µ (80/20 rule)
4. **Optimize** ‚Äî –æ–ø—Ç–∏–º—ñ–∑—É–π—Ç–µ —Ç—ñ–ª—å–∫–∏ —Ü–µ –º—ñ—Å—Ü–µ
5. **Verify** ‚Äî –≤–∏–º—ñ—Ä—è–π—Ç–µ –∑–Ω–æ–≤—É, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —â–æ –Ω–µ –∑–ª–∞–º–∞–ª–∏ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å
6. **Repeat** ‚Äî —è–∫—â–æ —Ç—Ä–µ–±–∞, –ø–æ–≤—Ç–æ—Ä—ñ—Ç—å

**–ó–æ–ª–æ—Ç–µ –ø—Ä–∞–≤–∏–ª–æ:** –ù–µ –æ–ø—Ç–∏–º—ñ–∑—É–π—Ç–µ —Ç–µ, —â–æ –≤–∏ –Ω–µ –≤–∏–º—ñ—Ä—è–ª–∏!

---

## –ü—Ä–∞–∫—Ç–∏—á–Ω–µ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è

**–î–∏–≤.:** [–ü—Ä–∞–∫—Ç–∏–∫—É–º 17: 1 Billion Row Challenge](p17_billion_row.md) ‚Äî –µ–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∞ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –æ–±—Ä–æ–±–∫–∏ –¥–∞–Ω–∏—Ö (–ø—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è —É 50+ —Ä–∞–∑—ñ–≤).

---

## –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ñ –ø–∏—Ç–∞–Ω–Ω—è

1. –ß–æ–º—É `std::vector` –∑–∞–∑–≤–∏—á–∞–π —à–≤–∏–¥—à–∏–π –∑–∞ `std::list`, –Ω–∞–≤—ñ—Ç—å –∫–æ–ª–∏ —Ç—Ä–µ–±–∞ –≤—Å—Ç–∞–≤–ª—è—Ç–∏ –µ–ª–µ–º–µ–Ω—Ç–∏ –≤ —Å–µ—Ä–µ–¥–∏–Ω—É?

<details markdown="1">
<summary>–í—ñ–¥–ø–æ–≤—ñ–¥—å</summary>

**Cache locality.** `std::vector` —Ç—Ä–∏–º–∞—î –≤—Å—ñ –¥–∞–Ω—ñ –ø–æ—Ä—É—á —É –ø–∞–º'—è—Ç—ñ ‚Üí CPU –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î —ó—Ö –≤–µ–ª–∏–∫–∏–º–∏ –±–ª–æ–∫–∞–º–∏ (cache lines) ‚Üí —à–≤–∏–¥–∫–æ. `std::list` —Ä–æ–∑–∫–∏–¥—É—î –≤—É–∑–ª–∏ –ø–æ –≤—Å—ñ–π –∫—É–ø—ñ ‚Üí –∫–æ–∂–µ–Ω `node->next` –º–æ–∂–µ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ cache miss ‚Üí –ø–æ–≤—ñ–ª—å–Ω–æ. –ù–∞–≤—ñ—Ç—å –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –∑—Å—É–≤—ñ–≤ –µ–ª–µ–º–µ–Ω—Ç—ñ–≤, `vector` —á–∞—Å—Ç–æ –ø–µ—Ä–µ–º–∞–≥–∞—î –∑–∞–≤–¥—è–∫–∏ –∫–µ—à—É.

</details>

2. –í–∏ –∫–æ–º–ø—ñ–ª—é—î—Ç–µ –ø—Ä–æ–≥—Ä–∞–º—É –∑ `-O0` —ñ –≤–æ–Ω–∞ –ø—Ä–∞—Ü—é—î 10 —Å–µ–∫—É–Ω–¥. –ó `-O3` –≤–æ–Ω–∞ –ø—Ä–∞—Ü—é—î 2 —Å–µ–∫—É–Ω–¥–∏. –ß–æ–º—É —Ç–∞–∫–µ –ø—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è?

<details markdown="1">
<summary>–í—ñ–¥–ø–æ–≤—ñ–¥—å</summary>

–ö–æ–º–ø—ñ–ª—è—Ç–æ—Ä –∑ `-O3` —Ä–æ–±–∏—Ç—å:
- **Loop unrolling** (—Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è —Ü–∏–∫–ª—ñ–≤)
- **Inline —Ñ—É–Ω–∫—Ü—ñ–π** (–≤–±—É–¥–æ–≤—É–≤–∞–Ω–Ω—è –º–∞–ª–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π)
- **Vectorization** (SIMD —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –¥–ª—è –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ—ó –æ–±—Ä–æ–±–∫–∏)
- **Dead code elimination** (–≤–∏–¥–∞–ª–µ–Ω–Ω—è –Ω–µ–≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ–≥–æ –∫–æ–¥—É)

–¶–µ –º–æ–∂–µ –¥–∞—Ç–∏ –ø—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è –¥–æ 10x –¥–ª—è –æ–±—á–∏—Å–ª—é–≤–∞–ª—å–Ω–æ-—ñ–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–≥–æ –∫–æ–¥—É.

</details>

3. –Ø–∫ –¥—ñ–∑–Ω–∞—Ç–∏—Å—è, —è–∫–∞ —Ñ—É–Ω–∫—Ü—ñ—è —É –≤–∞—à—ñ–π –ø—Ä–æ–≥—Ä–∞–º—ñ –Ω–∞–π–ø–æ–≤—ñ–ª—å–Ω—ñ—à–∞?

<details markdown="1">
<summary>–í—ñ–¥–ø–æ–≤—ñ–¥—å</summary>

–í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –ø—Ä–æ—Ñ–∞–π–ª–µ—Ä:
```bash
perf record -g ./my_program
perf report
```

–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ, –º–æ–∂–Ω–∞ –≤—Ä—É—á–Ω—É –æ–±–≥–æ—Ä–Ω—É—Ç–∏ –∫–æ–∂–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é —É Timer, –∞–ª–µ —Ü–µ —Ç—Ä—É–¥–æ–º—ñ—Å—Ç–∫–æ.

</details>

4. –ß–æ–º—É `reserve()` –¥–ª—è `std::vector` –º–æ–∂–µ –ø—Ä–∏—Å–∫–æ—Ä–∏—Ç–∏ –∫–æ–¥ —É –∫—ñ–ª—å–∫–∞ —Ä–∞–∑—ñ–≤?

<details markdown="1">
<summary>–í—ñ–¥–ø–æ–≤—ñ–¥—å</summary>

–ë–µ–∑ `reserve()`, –∫–æ–ª–∏ –≤–µ–∫—Ç–æ—Ä –ø–µ—Ä–µ–ø–æ–≤–Ω—é—î—Ç—å—Å—è, –≤—ñ–Ω:
1. –í–∏–¥—ñ–ª—è—î –Ω–æ–≤–∏–π –±–ª–æ–∫ –ø–∞–º'—è—Ç—ñ (–∑–∞–∑–≤–∏—á–∞–π x2)
2. –ö–æ–ø—ñ—é—î –í–°–Ü –µ–ª–µ–º–µ–Ω—Ç–∏ —Ç—É–¥–∏
3. –í–∏–¥–∞–ª—è—î —Å—Ç–∞—Ä–∏–π –±–ª–æ–∫

–î–ª—è 1 –º—ñ–ª—å–π–æ–Ω–∞ –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ —Ü–µ –º–æ–∂–µ —Å—Ç–∞—Ç–∏—Å—è ~20 —Ä–∞–∑—ñ–≤. –ó `reserve(1'000'000)` –≤–∏–¥—ñ–ª–µ–Ω–Ω—è –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è **–æ–¥–∏–Ω —Ä–∞–∑**.

</details>
